{% extends "core/base.html" %}
{% block title %}Report {{ det.id }}{% endblock %}
{% block content %}
<div class="row g-4">
  <div class="col-md-5">
    <div class="card shadow-sm">
      <div class="card-header">
        Original image
      </div>
      <div class="card-body">
        <img src="{{ det.upload.image.url }}" class="img-fluid rounded image-preview" alt="">
        <p class="mt-2 small text-light">
          {{ det.upload.original_filename }}<br>
          Uploaded: {{ det.upload.created_at|date:"Y-m-d H:i" }}
        </p>
      </div>
    </div>
  </div>

  <div class="col-md-7">
    <div class="card shadow-sm mb-3">
      <div class="card-header">
        Detection result
      </div>
      <div class="card-body">
        <p class="mb-1 text-light">
          Prediction:
          {% if det.is_real %}
            <span class="badge bg-success">Real image</span>
          {% else %}
            <span class="badge bg-danger">AI-generated image</span>
          {% endif %}
        </p>
        <p class="mb-2 text-light">
          Confidence: {{ det.confidence|floatformat:2 }}% ({{ det.confidence|floatformat:0 }}% certain)
        </p>
        <div class="progress mb-3" style="height: 20px;">
          <div class="progress-bar {% if det.is_real %}bg-success{% else %}bg-danger{% endif %}"
               role="progressbar"
               style="width: {{ det.confidence|floatformat:0 }}%;"
               aria-valuenow="{{ det.confidence|floatformat:0 }}"
               aria-valuemin="0"
               aria-valuemax="100">
            {{ det.confidence|floatformat:0 }}%
          </div>
        </div>

        <a href="{% url 'reports:pdf' det.id %}" class="btn btn-outline-secondary btn-sm">
          Download PDF report
        </a>
      </div>
    </div>

    <div class="card shadow-sm mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Explainable AI (Gradâ€‘CAM)</span>
        {% if not det.explanation %}
          <a href="{% url 'xai:generate' det.id %}" class="btn btn-sm btn-outline-primary">
            Generate heatmap
          </a>
        {% endif %}
      </div>
      <div class="card-body">
        {% if det.explanation %}
          <div class="row g-3">
            <div class="col-md-6">
              <img src="{{ det.upload.image.url }}" class="img-fluid rounded" alt="">
            </div>
            <div class="col-md-6">
              <img src="{{ det.explanation.heatmap_image.url }}" class="img-fluid rounded" alt="">
            </div>
          </div>
        {% else %}
          <p class="text-light mb-0">No explanation generated yet.</p>
        {% endif %}
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Source attribution</span>
        {% if not det.source_attr %}
          <a href="{% url 'source_attribution:run' det.id %}" class="btn btn-sm btn-outline-primary">
            Run attribution
          </a>
        {% endif %}
      </div>
      <div class="card-body">
        {% if det.source_attr %}
          <p class="mb-1 text-light">
            Likely source:
            <span class="badge bg-info text-dark">{{ det.source_attr.source_label }}</span>
          </p>
          <p class="mb-1 text-light">
            Confidence: {{ det.source_attr.confidence|floatformat:2 }}
          </p>
          <p class="small text-light mb-0">
            {{ det.source_attr.notes }}
          </p>
        {% else %}
          <p class="text-light mb-0">Source attribution not computed yet.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
